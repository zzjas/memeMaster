import*as button from"./button.js";import*as db from"./firebase.js";import*as share from"./share.js";const B2C=.8365,defaultF2C=4.48/40;let firebase=app_firebase,uid=null,containerSize=500;const defaultInfo={raw:localStorage.imgURL||"./img/doge.jpeg",rendered:"",title:localStorage.title||"",key:"",date:"",imgSize:localStorage.imgSize||451,lastContainerSize:"",editable:1,top:{fontSize:4.48/40*containerSize,pos:0,text:"Upper Text",lastDrag:0},bot:{fontSize:4.48/40*containerSize,pos:B2C*containerSize,text:"Lower Text",lastDrag:0}};let info=defaultInfo,imgRatio=info.imgSize/containerSize,editting=!1;function checkEdit(){localStorage.editting?(editting=parseInt(localStorage.editting))&&localStorage.info&&(info=JSON.parse(localStorage.info),console.log(info.top.pos+", "+info.bot.pos+", "+info.lastContainerSize),containerSize=info.lastContainerSize):editting=!1}function main(){firebase.auth().onAuthStateChanged(checkSignIn),checkEdit(),handleResize(),renderMemeContainer(),initTextBoxes(),window.addEventListener("resize",()=>{handleResize(),renderMemeContainer()});let e=uploadcare.Widget("#uploadButton");document.querySelectorAll("#uploadButton + div button")[0].innerHTML="Upload Picture To Make Meme",e.onUploadComplete(uploadHandleComplete);let t=uploadcare.Widget("#acquireButton");document.querySelectorAll("#acquireButton + div button")[0].innerHTML="Upload Meme To Account",document.querySelectorAll("#acquireButton + div button")[0].parentNode.style.marginLeft="10%",document.querySelectorAll("#acquireButton + div button")[0].parentNode.style.marginRight="10%",t.onUploadComplete(acquireHandleComplete),document.querySelector("#generateButton").addEventListener("click",handleGenerate)}function initTextBoxes(){document.getElementById("memeImg").ondragstart=function(){return!1},["#topText","#bottomText"].forEach(e=>{let t=document.querySelector(e),o=t.querySelector("textarea"),n=t.querySelector(".dragLayer"),i=o.scrollWidth;o.addEventListener("keyup",()=>{let t="#topText"==e?info.top:info.bot;for(t.text=o.value;o.scrollWidth>i&&t.fontSize>0;)t.fontSize-=1,o.setAttribute("style",`font-size: ${t.fontSize}px;`);"#topText"==e?info.top=t:info.bot=t}),n.addEventListener("dragstart",t=>{let o="#topText"==e?info.top:info.bot;o.lastDrag=t.screenY,document.querySelector("#uploadButton + div").style.visibility="hidden",document.querySelector("#acquireButton + div").style.visibility="hidden","#topText"==e?info.top=o:info.bot=o,renderMemeContainer()}),n.addEventListener("drag",o=>{let n="#topText"==e?info.top:info.bot;o.preventDefault();let i=o.screenY-n.lastDrag,a=n.pos+i;n.lastDrag=o.screenY,a>0&&a<B2C*containerSize&&(n.pos=a),t.style.top=n.pos+"px","#topText"==e?info.top=n:info.bot=n})})}function renderMemeContainer(){let e=document.querySelector("#memeContainer").querySelector("#memeImg");e.src!=info.raw&&(e.crossOrigin="anonymous",e.src=info.raw),imgRatio=info.imgSize/containerSize,["#topText","#bottomText"].forEach(e=>{const t="#topText"==e;let o=document.querySelector(e),n=o.querySelector("textarea");n.style.fontSize=`${t?info.top.fontSize:info.bot.fontSize}px`,n.value=t?info.top.text:info.bot.text,o.style.top=`${t?info.top.pos:info.bot.pos}px`})}function handleResize(){let e=document.querySelector("#memeContainer").clientWidth,t=e/containerSize;imgRatio=info.imgSize/e,info.top.fontSize*=t,info.top.pos*=t,info.bot.fontSize*=t,info.bot.pos*=t,containerSize=e,info.lastContainerSize=containerSize}function handleGenerate(){button.startLoading();let e=document.querySelector("#memeImg"),t=document.querySelector("#myCanvas"),o=t.getContext("2d");o.canvas.width=e.naturalWidth,o.canvas.height=e.naturalHeight,o.drawImage(e,0,0),o.textAlign="center";let n=info.top.pos/containerSize*o.canvas.height+info.top.fontSize*imgRatio,i=info.bot.pos/containerSize*o.canvas.height+info.bot.fontSize*imgRatio;o.font=`${info.top.fontSize*imgRatio}px Impact`,drawStroked(o,info.top.text,.5*o.canvas.width,n,info.top.fontSize),o.font=`${info.bot.fontSize*imgRatio}px Impact`,drawStroked(o,info.bot.text,.5*o.canvas.width,i,info.bot.fontSize),uploadRenderedImg(t.toDataURL("image/png"))}function drawStroked(e,t,o,n,i){e.strokeStyle="black",e.lineWidth=7/45*i*imgRatio,e.strokeText(t,o,n),e.fillStyle="white",e.fillText(t,o,n)}function uploadRenderedImg(e){let t=atob(e.split(",")[1]),o=[];for(let e=0;e<t.length;e++)o.push(t.charCodeAt(e));let n=new Blob([new Uint8Array(o)],{type:"image/png"});n.lastModifiedDate=new Date,n.name=info.title,uploadcare.fileFrom("object",n).done(e=>{openDialog(e.cdnUrl)}).fail(()=>{console.error("Upload Failed")})}function openDialog(e){let t=document.getElementsByTagName("template")[0].content.querySelector("dialog").cloneNode(!0),o=t.querySelector("img");o.setAttribute("src",e),o.addEventListener("load",()=>{t.showModal()}),t.querySelector("#succDownloadButton").addEventListener("click",button.generateDownloadHandler(e,info.title));let n=t.querySelector("#succShareButton");share.initShare(n,t,e);let i=t.querySelector("#succSaveButton"),a=()=>{uid?(info.rendered=e,info.date=new Date,editting?db.app_main.updateMeme(uid,info):db.app_main.createMeme(uid,db.count,info),setTimeout(()=>{editting?(localStorage.setItem("editting",0),localStorage.removeItem("info"),window.location.href="./myMeme.html"):(i.removeEventListener("click",a),i.innerHTML='<img src="./img/save-success.svg"><a href="./myMeme.html">Saved! Click to See Saved Meme</a>')},800)):i.innerHTML='<a href="./login.html">SignUp/LogIn To Save In Account</a>'};i.addEventListener("click",a),t.querySelector("#succDiscardButton").addEventListener("click",function(){let e=document.querySelector("dialog");e.parentElement.removeChild(e)}),setTimeout(button.endLoading,500),document.body.appendChild(t)}function checkSignIn(e){let t=document.querySelector("#changePasswordButton"),o=document.querySelector("#myMemeButton"),n=document.querySelector("#logoutButton"),i=document.querySelector("#signupButton"),a=document.querySelector("#loginButton");e?(uid=e.uid,db.app_main.retriveData(uid),t.style.display="",o.style.display="",n.style.display="",i.style.display="none",a.style.display="none",o.addEventListener("click",button.generateGoToURLHandler("./myMeme.html")),t.addEventListener("click",button.generateGoToURLHandler("./changepw.html")),n.addEventListener("click",()=>{firebase.auth().signOut(),window.location.href=window.location.href})):(uid=null,"none"!==t.style.display&&(t.style.display="none"),"none"!==o.style.display&&(o.style.display="none"),"none"!==n.style.display&&(n.style.display="none"),i.style.display="",a.style.display="",i.addEventListener("click",button.generateGoToURLHandler("./login.html")),a.addEventListener("click",button.generateGoToURLHandler("./login.html")))}function uploadHandleComplete(e){info.raw=e.cdnUrl;let t=/(?:crop\/)[0-9]*/,o=info.raw.match(t);o?(t=/\d+/,info.imgSize=parseInt(o[0].match(t)[0])):info.imgSize=e.originalImageInfo.width,info.title="meme_"+e.name,handleResize(),localStorage.setItem("title",info.title),localStorage.setItem("imgSize",info.imgSize),localStorage.setItem("imgURL",info.raw),window.location.href=window.location.href}function acquireHandleComplete(e){info.raw=e.cdnUrl;let t=/(?:crop\/)[0-9]*/,o=info.raw.match(t);o?(t=/\d+/,info.imgSize=parseInt(o[0].match(t)[0])):info.imgSize=e.originalImageInfo.width,info.rendered=info.raw,info.title=`meme_${e.name}`,info.editable=0,info.date=new Date,db.app_main.createMeme(uid,db.count,info),setTimeout(()=>{window.location.href="./myMeme.html"},500)}window.addEventListener("load",()=>main());
