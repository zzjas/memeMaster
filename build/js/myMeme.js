import*as db from"./firebase.js";import*as button from"./button.js";let uid=null,memeList=[],tableView=localStorage.tableView?parseInt(localStorage.tableView):1;async function main(){firebase.auth().onAuthStateChanged(e=>{e?(uid=e.uid,db.app_main.retriveData(uid)):window.location.href="index.html"}),document.querySelector("#toggleView").addEventListener("click",handleToggleView),document.querySelector("#logOutButton").addEventListener("click",()=>{firebase.auth().signOut(),button.generateGoToURLHandler("./login.html")}),document.querySelector("#newMemeButton").addEventListener("click",button.generateGoToURLHandler("./index.html")),document.querySelector("#changePasswordButton").addEventListener("click",button.generateGoToURLHandler("./changepw.html"));let e=document.createElement("img");e.id="loading",e.src="./img/loading.svg",document.body.appendChild(e);let t=0;for(;0==memeList.length;){if(25==++t){let e=document.createElement("p");e.id="warning",e.innerHTML="Go make a new meme so that the cute cat can have a rest!",document.body.appendChild(e)}memeList=db.item,await sleep(200)}memeList.sort(sortByProp("-date")),document.body.removeChild(e),checkView()}function renderList(e){memeList.forEach(t=>{let n=document.createElement("div");n.className=`${e}Panel panel`;let i=new Image;i.setAttribute("class","meme"),i.addEventListener("load",()=>{n.appendChild(i);let e=document.createElement("div");e.setAttribute("class","info");let a=document.createElement("p");a.setAttribute("class","title"),a.innerHTML=`${t.title} [Last Edited @ ${t.date.toDateString()}]`,e.appendChild(a);let o=document.createElement("div");o.setAttribute("class","listButtons");let l=button.createButton("trash");if(l.addEventListener("click",()=>{confirm("Be careful! You will lose this fantastic meme forever if you choose OK")&&db.app_main.deleteMeme(uid,t.key,()=>{button.startLoading(),window.location.href=window.location.href})}),o.appendChild(l),t.editable){let e=button.createButton("edit");e.addEventListener("click",()=>{localStorage.setItem("editting",1),localStorage.setItem("info",JSON.stringify(t)),window.location.href="./index.html"}),o.appendChild(e)}let d=button.createButton("share");d.addEventListener("click",()=>{const e=document.createElement("input");e.value=t.rendered,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),alert("Link has been copied to clipboard!")}),o.appendChild(d);let r=button.createButton("download");r.addEventListener("click",button.generateDownloadHandler(t.rendered,t.title)),o.appendChild(r),e.appendChild(o),n.appendChild(e),document.querySelector("main").appendChild(n)}),i.src=t.rendered})}function checkView(){let e=document.querySelector("#toggleView");(tableView=localStorage.tableView?parseInt(localStorage.tableView):1)?(e.innerHTML="List",removePanels(),renderList("table")):(e.innerHTML="Table",removePanels(),renderList("list"))}function removePanels(){document.querySelector("main").innerHTML=""}function handleToggleView(){tableView=tableView?0:1,localStorage.setItem("tableView",tableView),checkView()}function sortByProp(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,i){return(n[e]<i[e]?-1:n[e]>i[e]?1:0)*t}}function sleep(e){return new Promise(t=>setTimeout(t,e))}window.addEventListener("load",main);
